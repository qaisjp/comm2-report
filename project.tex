
% to choose your degree
% please un-comment just one of the following
\documentclass[bsc,frontabs,twoside,singlespacing,parskip,deptreport]{infthesis}     % for BSc, BEng etc.
% \documentclass[minf,frontabs,twoside,singlespacing,parskip,deptreport]{infthesis}  % for MInf

\begin{document}

\title{Build a website to share and discuss software packages}

\author{Qais Patankar}

% to choose your course
% please un-comment just one of the following
% \course{Artificial Intelligence and Computer Science}
%\course{Artificial Intelligence and Software Engineering}
%\course{Artificial Intelligence and Mathematics}
%\course{Artificial Intelligence and Psychology }
%\course{Artificial Intelligence with Psychology }
%\course{Linguistics and Artificial Intelligence}
\course{BEng Computer Science}
%\course{Software Engineering}
%\course{Computer Science and Electronics}
%\course{Electronics and Software Engineering}
%\course{Computer Science and Management Science}
%\course{Computer Science and Mathematics}
%\course{Computer Science and Physics}
%\course{Computer Science and Statistics}

% to choose your report type
% please un-comment just one of the following
%\project{Undergraduate Dissertation} % CS&E, E&SE, AI&L
%\project{Undergraduate Thesis} % AI%Psy
\project{4th Year Project Report}

\date{\today}

\abstract{

!!TODO!! THIS SECTION IS JUST THE PROJECT DESCRIPTION RN !!TODO!!

These software packages are in the form of ``resources''. Resources are archives containing a metadata files, scripts and other miscellaneous files.

Resources can have assets attached in the form of YouTube videos or screenshots. Users can comment on resources, vote on comments, and it should be possible for authors or other users to respond to comments (similar, but not restricted to, a Q\&A format).

Resources can also be dependent on other resources (dependencies). It should be easy to download a resource (or a tree of resources, when we considered dependencies) — this can either be through the web interface or through a companion CLI.

These resources contain code that may be downloaded and executed by other users, so security must be considered. It must be possible for website administrators to easily (bulk) review resources and leave feedback for resource creators. There could also be some inbuilt heuristics to automatically determine whether or not a resource is dangerous.

Users should be able to showcase the projects they have worked on. It should also be possible for multiple users to collaborate on a project together.
}

\maketitle

\section*{Acknowledgements}
Thank you to my supervisor, Stephen Gilmore, for TODO.

!!TODO!!

\tableofcontents

%\pagenumbering{arabic}


\chapter{Introduction}

The document structure should include:
\begin{itemize}
\item
The title page  in the format used above.
\item
An optional acknowledgements page.
\item
The table of contents.
\item
The report text divided into chapters as appropriate.
\item
The bibliography.
\end{itemize}

Commands for generating the title page appear in the skeleton file and
are self explanatory.
The file also includes commands to choose your report type (project
report, thesis or dissertation) and degree.
These will be placed in the appropriate place in the title page.

The default behaviour of the documentclass is to produce documents typeset in
12 point.  Regardless of the formatting system you use,
it is recommended that you submit your thesis printed (or copied)
double sided.

The report should be printed single-spaced.
It should be 30 to 60 pages long, and preferably no shorter than 20 pages.
Appendices are in addition to this and you should place detail
here which may be too much or not strictly necessary when reading the relevant section.

\section{Citations}

Note that citations
(like \cite{P1} or \cite{P2})
can be generated using {\tt BibTeX} or by using the
{\tt thebibliography} environment. This makes sure that the
table of contents includes an entry for the bibliography.
Of course you may use any other method as well.

\section{Options}

There are various documentclass options, see the documentation.  Here we are
using an option ({\tt bsc} or {\tt minf}) to choose the degree type, plus:
\begin{itemize}
\item {\tt frontabs} (recommended) to put the abstract on the front page;
\item {\tt twoside} (recommended) to format for two-sided printing, with
  each chapter starting on a right-hand page;
\item {\tt singlespacing} (required) for single-spaced formating; and
\item {\tt parskip} (a matter of taste) which alters the paragraph formatting so that
paragraphs are separated by a vertical space, and there is no
indentation at the start of each paragraph.
\end{itemize}

\chapter{API Design}

API design is inspired from GitHub's Rest API v3. https://developer.github.com/v3/

This is a good RESTful API.

\section{Permission management}

We've decided that permissions will be granular for site administrators, but simple on a resource level. Original creators of a resource retain permanent access rights, and they can also designate additional resource administrators. These designated resource admins have all the same permissions as the creator.

\section{Authentication}

Authentication is implemented as a middleware.

Initially we had two middleware functions:
\begin{itemize}
  \item \emph{authRequired} - this is returned by the JWT library \\ (\emph{authMiddleware.MiddlewareFunc()}). Any route that includes this middleware function requires the request to have an authenticated user.
  \item \emph{authMaybeRequired} - this is a function we've created that, if an auth token is provided, verifies the user (via \emph{authRequired}), and otherwise sets the "user" context variable to \emph{nil}.
\end{itemize}

This works well when \emph{authMaybeRequired} isn't used frequently, but we soon discovered that a lot of our routes included this. Some entities - resources, packages, gallery items — may be in a state that means that they should only be accessible to resource managers and site admins.

We decided to change to three middleware functions:
\begin{itemize}
  \item \emph{authMiddlewareFunc} - this is returned by the JWT library \\ via \emph{authMiddleware.MiddlewareFunc()}, as \emph{authRequired} above
  \item \emph{authMaybeRequired} - this is the same as above except it verifies the user via \emph{authMiddlewareFunc}
  \item \emph{authRequired} - this is a function we've created that, if the "user" context variable is \emph{nil}, will abort, and send a response containing:
   \begin{itemize}
     \item the header "\emph{WWW-Authenticate}" to "\emph{JWT realm=multitheftauto.com}",
     \item the status code to \emph{401 Status Unauthorized}, and
     \item the body \emph{\{"message": "You must be logged in to perform that operation."\}}
   \end{itemize}
\end{itemize}

Full list:

\begin{itemize}
  \item resources - unpublished resources, suspended resources
  \item packages - draft packages
\end{itemize}

\section{Deletions}

A common approach to deleting entities in webapps (todo: add source) is to set an \emph{is\_deleted} flag to \emph{true} and simply hide the row from output.

This is useful if we need to maintain an audit log or (considering that deletions
are destructive) would like to undo changes.

Users, however, may not approeciate a website holding onto data they've requested to
be deleted.

When deleting \emph{resources} we can just do \emph{delete from resources where resource\_id = }
and let PostgreSQL cascade this via foreign keys.

Doing this for general users has a few caveats:
\begin{itemize}
  \item If a user has requested a deletion, their comments should be anonymised
  \item If an administrator has deleted the account,
        the admin should decide whether or not their comments should be removed too.
  \item What if an admin decides, post-comment-retaining-deletion, that their posts should have indeed been deleted?
\end{itemize}

What if an administrator wants to delete their own account? Most actions (like bans) have an
admin user id associated, and the deletion of an admin account should not delete all the associated bans!

Solutions here include:

\begin{itemize}
  \item For comments and bans, allow "author\_id" to be nullable. Show "deleted" in place.
  \item When deleting user accounts, delete all the associated data, but keep the user row, and set "is\_deleted" to true. We should also remove all personal data.
\end{itemize}

This is in line with GDPR as only PII needs to be removed. Comments do not fall under GDPR.


\section{Upload packages}

It is possible for a user to send many \emph{POST /v1/resources/:resource\_id/pkg} requests, creating many blank packages. These will all be created a draft packages until:

\begin{itemize}
  \item an actual file has been uploaded (and checked)
  \item the user publishes the package (it is no longer in a ``draft'' state)
\end{itemize}

Once a file is uploaded by the client and is memory, we check the MIME type of the uploaded file. If the file is not of the ``application/zip'' MIME type, we return a ``415 Unsupported Media Type'' and discard the data.

TODO THEN WE CHECK THE ZIP ITSELF IN memory

Once we've verified that the zip is safe to use, we upload to a storage service using gocloud.dev/blob https://gocloud.dev/howto/blob.

\begin{quote}
  "Blobs are a common abstraction for storing unstructured data on Cloud storage services and accessing them via HTTP. This guide shows how to work with blobs in the Go CDK."
\end{quote}

This is useful as it is a generic backend for various file storage services, including support for Google Cloud Storage, Amazon S3, Azure Blob Service, and of course Local Storage. This makes the website scalable and resilient as we can rely on one of those services doing backups for us, and also use them to deliver stuff for us. Less bandwidth. But we can still use Local Storage when sysadmins are testing or if they would prefer to use local storage (if they do not want to pay for an external service)

The gocloud.dev library gives us safety as it converts filenames to something safe. This means that we don't have to worry about malicious filenames when storing files locally.

The filename ``../test'' is stored as ``..\_\_0x2f\_\_test''. This is secure.

However, gocloud allows filenames to contain forward slashes (creating a subfolder). Whilst we could ensure that our filename has no directory separators, we chose to force filenames to be stored as ``pkg\${ID}.zip'' (such as pkg6.zip).

This additionally means that we don't need to write code to delete old packages when reuploading a file (during initial package creation, whilst in draft state). We can just rely on gocloud.dev replacing the blob with the new file.

We only need to delete the files when packages are deleted!

\section{Selecting HTTP status codes}

\subsection{401 Unauthorized vs. 403 Forbidden}

We have decided to select the following status codes for the following scenarios:

\begin{itemize}
  \item 401: being unauthenticated for a request that requires authentication
  \item 403: being authenticated but not authorized to perform an action
\end{itemize}

This might seem obvious, but the status text for \emph{401} is \emph{401 Unauthorized},
despite it being for authentication and not authorization.

Sources: (todo: citationify)
\begin{itemize}
  \item https://stackoverflow.com/questions/3297048/403-forbidden-vs-401-unauthorized-http-responses
  \item https://httpstatuses.com/401
  \item https://httpstatuses.com/403
\end{itemize}



% use the following and \cite{} as above if you use BibTeX
% otherwise generate bibtem entries
\bibliographystyle{plain}
\bibliography{mybibfile}

\end{document}
